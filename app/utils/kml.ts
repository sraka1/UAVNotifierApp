import { map } from "lodash"
import { create } from "xmlbuilder2"
import RNFS from "react-native-fs"
import { Flight } from "app/models/Flight"
import { Buffer } from "buffer"

// TODO: Move this to assets
const XML_TEMPLATE =
  '<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Pot leta</name><description>Flight path</description><Style id="PolygonPath"><LineStyle><color>FF000000</color><width>3</width></LineStyle><PolyStyle><color>300000FF</color></PolyStyle></Style><Style id="PolygonEdge"><IconStyle><Icon><href>data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAB71BMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABXL+KSAAAApXRSTlMAID1TZl1OKwgjdbjr//7SkUwFCc/pjyILfvqcH+X1cQMatMYcPuZAYvv4S3Jq9zdH/OcbIe/2rDgWBhlDfczDAnYP/x577HBbEw0S8R3AqeCnMQeyYOH9x1GGuugEVkab4p3Nre1pXzo2fxWvLtcp4zUYvwGVyN9EnhCjgif5xYqkhTDu9E3zsYuSdG+wbAo5rrZkiSyDPFzeKPCHlM7qJrXQQmNXmaIpAAACwklEQVR4nO2W+VsSQRjHR1rFg6GsILVUrDRLwDAhocNjJUKwi5IuLLNDMzrMzCy76bCy0m61+w8Nqmffd3ZnZzefp9/8/vjO9/NhdhmWJWQx/zd5liWSlF9gLVwIXFRcYqN/Y1+6rHT5P9ErpJVUFYdzlWm8rNymxnOpWL3GHJ9fycNzqap2GeM1a/XwXNatN+Jr60Q8pbYNYr5+o5indFODiHfbjXixwWOCp9TbqMdv9pnhKW3awueb/WwvsNXTEgwVbtu+Y6fK0NrGFZQwJX97h6ykM7yLWYzw+N244XNGZSZdYby/qiItH3OgQrxB1qR7Dyrs1QrK0fI+q5aX5dB+aNgPqPlEE/p8Lp81oD0cVAsOoevn7P9PYj1KKZmnEhwGgVOPl+Uj0DrK8lE4Q/6ovkA+ptSOpxhBL6jbBbzcAL0TjOCkMg90iASuPqV4ihH0K/PTIl6W4ZPOuLAATupZseAcXMMA4rtg3CIWDELzPBJYYTwkFjRD8wISpGGcEAuGoHkRCS7BOCQWFEHzMhKgcVAsuALNPiQYNn0T66F5FQlG4srYIxZcA4ETn4NRZWxwkK6DYAwLbijjwLiIbwTewfzhS7BQLRLchN4t5rcwnFQWKsv0+Qn41d+uYQTkDqjv6gvQk/8eyxM3LCVL9Xh0oXRQJRiHL1L3oWrxQqeVqHMf2fmP9QcPUcWiEQxl0HKccxWPHqPCEw1PSBit0+RT1XfRMYn/ujPqh3ouqVFsoHVudKJiz9g3n+ccnpCJAFOi3hdTA8HEy85Xkdeqlek2roDMUHPpifJ5Qt6Y4v1v9XgyMmmCr6rV5bOGd4avWf73Aj6bDxkx/zEt5gn51C/ip3XvHyQVmdXDZ2dGjPlsYnNxHl4xHzSF59I19VmNf5nrNI3/ztfib8o+fN/nx1LGiDbdP3ol6WdBumwh8GLM5xcw1FXgGNyB2QAAAABJRU5ErkJggg==</href></Icon></IconStyle></Style><Style id="TakeOffPoint"><IconStyle><Icon><href>data:image/png;base64,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</href></Icon></IconStyle></Style></Document></kml>'

export async function generateKml(flight: Flight) {
  const doc = create(XML_TEMPLATE)

  const { selectedLocations, takeOffLandingLocation, id } = flight

  // Flight area
  const flightAreaJson = {
    Placemark: {
      name: "Območje letenja - 2D",
      description: "Flight area - 2D. Do višine 50m nad terenom. Up to 50m above ground.",
      styleUrl: "#PolygonPath",
      Polygon: {
        tessellate: 1,
        altitudeMode: "clampToGround",
        outerBoundaryIs: {
          LinearRing: {
            // First point is repeated at the end to close the polygon
            coordinates: `${map(
              selectedLocations,
              (location) => `${location.longitude},${location.latitude},0.0`,
            ).join(" ")} ${selectedLocations[0].longitude},${selectedLocations[0].latitude},0.0`,
          },
        },
      },
    },
  }
  doc
    .root()
    .find((node) => node.node.nodeName === "Document")
    .ele(flightAreaJson)

  // Take-off and landing point
  const takeOffLandingPointJson = {
    Placemark: {
      name: "Točka vzleta in pristanka",
      description: "Take-off and landing point",
      styleUrl: "#TakeOffPoint",
      Point: {
        coordinates: `${takeOffLandingLocation.longitude},${takeOffLandingLocation.latitude},0.0`,
      },
    },
  }
  doc
    .root()
    .find((node) => node.node.nodeName === "Document")
    .ele(takeOffLandingPointJson)

  // Flight area boundaries
  map(selectedLocations, (location, index) => {
    const point = {
      Placemark: {
        name: `T${index + 1}`,
        description: `T${index + 1}`,
        styleUrl: "#PolygonEdge",
        Point: {
          coordinates: `${location.longitude},${location.latitude},0.0`,
        },
      },
    }
    doc
      .root()
      .find((node) => node.node.nodeName === "Document")
      .ele(point)
  })

  const xml = doc.end({ prettyPrint: true })

  // Store the KML file
  const filePath = `${RNFS.DocumentDirectoryPath}/obmocje_letenja_${id}.kml`
  await RNFS.writeFile(filePath, xml, "utf8")

  return [filePath, Buffer.from(xml).toString("base64")]
}
